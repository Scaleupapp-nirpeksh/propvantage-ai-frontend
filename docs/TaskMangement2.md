# PropVantage AI - Task System: Supplementary Notes for Frontend

**This supplements `TASK_SYSTEM_FRONTEND_DOCUMENTATION.md` with backend architecture context, AI Copilot integration, and auto-generation internals.**

---

## 1. What's Already Covered (in TASK_SYSTEM_FRONTEND_DOCUMENTATION.md)

- All 22 API endpoints with request/response shapes
- TypeScript interfaces for all models
- All enums and constants
- Status state machine transitions
- UI color recommendations
- Template system
- Analytics facets
- Error codes
- Permission matrix

**If your question is "what API do I call?" — that doc has the answer.**

This document answers: "What else is happening behind the scenes that I should know about?"

---

## 2. AI Copilot — Now Supports Task Queries

The existing AI Copilot chat (`POST /api/copilot/chat`) **now understands task-related questions**. No new API endpoints were added — the same chat endpoint handles it automatically.

### What Users Can Ask the Copilot

| Question Type | Example Queries | Copilot Function Called |
|---|---|---|
| Task overview | "How many tasks are open?", "Task status breakdown" | `get_task_summary` |
| My tasks | "What are my tasks?", "What do I need to do today?" | `get_my_tasks` |
| Team workload | "Who has the most tasks?", "Team task distribution" | `get_team_task_workload` |
| Overdue tasks | "Show overdue tasks", "What tasks are late?" | `get_overdue_tasks` |
| Task lookup | "Show me TASK-042", "Find task about payment follow-up" | `get_task_details` |
| Task analytics | "Task performance this month", "Average resolution time" | `get_task_analytics` |

### Frontend Impact

- **No UI changes needed** for the copilot to answer task questions — it works through the existing chat interface.
- The `sources` array in copilot responses can now include `"tasks"` — use this if you show source badges.
- The `intent.category` can now be `"tasks"` — use this if you do category-based UI (icons, colors, routing).
- Follow-up questions from the copilot will naturally suggest task-related queries.

### Response Examples

User asks: _"What are my tasks?"_

The copilot returns data grouped by urgency:
```json
{
  "overdue": { "count": 3, "tasks": [...] },
  "dueToday": { "count": 2, "tasks": [...] },
  "dueThisWeek": { "count": 5, "tasks": [...] },
  "inProgress": { "count": 4, "tasks": [...] }
}
```

User asks: _"Task analytics this month"_

The copilot returns:
```json
{
  "totalTasks": 87,
  "completedTasks": 52,
  "completionRate": 59.8,
  "overdueCount": 12,
  "avgResolutionTimeHours": 34.2,
  "statusDistribution": [...],
  "categoryDistribution": [...],
  "overdueAging": [
    { "bucket": "1-7 days", "count": 6 },
    { "bucket": "8-14 days", "count": 3 },
    { "bucket": "15-30 days", "count": 2 },
    { "bucket": "30+ days", "count": 1 }
  ]
}
```

---

## 3. Task Creation Touch Points — Full Map

Tasks are NOT only created via `POST /api/tasks`. The frontend should be aware of all creation sources because auto-generated tasks will appear in user dashboards without the user having created them.

### 3.1 Manual (User-initiated)

| Action | Endpoint | When |
|---|---|---|
| Direct creation | `POST /api/tasks` | User fills create-task form |
| Sub-task creation | `POST /api/tasks/:id/subtasks` | User adds sub-task under a parent |
| Template application | `POST /api/tasks/templates/:id/apply` | User applies a template (creates parent + sub-tasks) |

### 3.2 Auto-Generated (System-initiated via Cron)

These run automatically on the backend. The frontend doesn't trigger them, but should **display** them properly.

| Trigger | Category | When | Frequency |
|---|---|---|---|
| **Overdue Payment** | Payment & Collection | Installment `dueDate` passes without payment | Every hour |
| **Missed Lead Follow-up** | Lead & Sales | Lead's `nextFollowUpDate` passes | Every hour |
| **Delayed Construction Milestone** | Construction | Milestone `plannedEndDate` passes | Every hour |
| **New Sale Onboarding** | Lead & Sales | Sale booked within last 7 days | Every hour |
| **Recurring Task** | (varies) | Task with `recurrence.isRecurring = true` reaches `nextOccurrence` | Every 15 min |

### 3.3 How to Identify Auto-Generated Tasks

Every auto-generated task has:
```json
{
  "autoGenerated": {
    "isAutoGenerated": true,
    "triggerType": "overdue_payment" | "missed_follow_up" | "delayed_milestone" | "new_sale_onboarding" | "recurring_schedule",
    "triggerEntityType": "Installment" | "Lead" | "ConstructionMilestone" | "Sale" | "Task",
    "triggerEntityId": "<ObjectId>",
    "deduplicationKey": "overdue_payment_<id>_2026-02-11"
  },
  "assignmentType": "system"
}
```

**UI Recommendation**: Show a badge or icon (e.g., "Auto-generated" or a robot icon) on tasks where `autoGenerated.isAutoGenerated === true`. Show the trigger type as a subtitle.

### 3.4 Deduplication

The backend prevents duplicate auto-generated tasks using `deduplicationKey`. For example:
- `overdue_payment_<installmentId>_2026-02-11` — one task per installment per day
- `new_sale_onboarding_<saleId>` — one task per sale ever (no date suffix)

The frontend doesn't need to worry about deduplication — the backend handles it.

---

## 4. Escalation System

Overdue tasks are automatically escalated to managers. This happens behind the scenes every 30 minutes.

### Escalation Levels

| Level | Triggers After | What Happens |
|---|---|---|
| Level 1 | 24 hours overdue | Manager notified, added as watcher |
| Level 2 | 48 hours overdue | Next-level manager notified |
| Level 3 | 72 hours overdue | Top-level escalation |

### What the Frontend Should Show

Each task has:
```typescript
escalations: Array<{
  level: number;        // 1, 2, or 3
  escalatedTo: User;    // Manager it was escalated to
  escalatedAt: Date;
  reason: string;       // e.g., "Task overdue by 36 hours (auto-escalation level 1)"
  acknowledged: boolean;
  acknowledgedAt?: Date;
}>;
currentEscalationLevel: number; // 0 = not escalated, 1-3 = escalation level
```

**UI Recommendation**:
- Show an escalation indicator (warning icon) when `currentEscalationLevel > 0`
- Color severity: Level 1 = yellow, Level 2 = orange, Level 3 = red
- Show escalation history in the task detail's activity timeline

---

## 5. Background Job Types

These are available for manual triggering via the admin panel (if you build one). They are NOT auto-triggered via cron — they use the existing `backgroundJobService` for on-demand execution.

| Job Type | What It Does |
|---|---|
| `TASK_AUTO_GENERATION` | Runs all 4 trigger checks (overdue payments, missed follow-ups, delayed milestones, new sale onboarding) |
| `TASK_RECURRING_GENERATION` | Generates instances of recurring tasks |
| `TASK_ESCALATION_CHECK` | Checks overdue tasks and escalates them |

The cron schedules that run automatically are:
- **Hourly** — All trigger checks (auto-generation)
- **Every 15 min** — Recurring task generation
- **Every 30 min** — Escalation checks

---

## 6. Entity Linking — Navigating from Tasks to Entities

Tasks can be linked to other business entities. The `linkedEntity` field tells you what entity the task relates to:

```typescript
linkedEntity: {
  entityType: 'Lead' | 'Sale' | 'PaymentPlan' | 'PaymentTransaction' | 'Installment' |
               'Invoice' | 'ConstructionMilestone' | 'Project' | 'Unit' | 'Contractor' |
               'User' | 'File';
  entityId: string;      // ObjectId of the linked entity
  displayLabel: string;  // Human-readable label, e.g., "Installment #5" or "Rahul Sharma"
}
```

**UI Recommendation**: Make `displayLabel` a clickable link that navigates to the relevant entity detail page. Map entity types to routes:

| entityType | Frontend Route |
|---|---|
| Lead | `/leads/:entityId` |
| Sale | `/sales/:entityId` |
| Installment | `/payments/installments/:entityId` |
| Project | `/projects/:entityId` |
| ConstructionMilestone | `/construction/milestones/:entityId` |
| Invoice | `/invoices/:entityId` |
| Unit | `/inventory/units/:entityId` |

---

## 7. Recurring Tasks — How They Work

When a user creates a task with recurrence settings, the backend automatically generates new task instances on schedule.

### User Creates:
```json
{
  "title": "Weekly Site Inspection",
  "recurrence": {
    "isRecurring": true,
    "pattern": "weekly",
    "interval": 1,
    "dayOfWeek": 1,
    "endDate": "2026-12-31"
  }
}
```

### What Happens:
1. The original task is the "source" — it stays in whatever status the user sets
2. Every week, the system clones it into a new task instance with:
   - Same title, description, category, priority, assignee
   - Fresh checklist (all items unchecked)
   - `autoGenerated.triggerType = "recurring_schedule"`
   - New `TASK-XXX` number
3. The source task's `recurrence.nextOccurrence` is updated to the next date
4. When `endDate` passes, `isRecurring` is set to `false` and generation stops

**UI Recommendation**:
- Show a recurring icon on the source task
- In the source task detail, show a list of generated instances (query by `autoGenerated.triggerEntityId = sourceTaskId`)
- Allow users to stop recurrence by setting `recurrence.isRecurring = false` via the update endpoint

---

## 8. New Sale Onboarding — Auto-Created Checklist

When a sale is booked, the system auto-creates an onboarding task with a pre-built checklist:

1. Collect KYC documents from buyer
2. Send agreement draft for review
3. Confirm payment schedule with buyer
4. Schedule registration date
5. Send welcome kit / handover documents

This task is assigned to the salesperson who closed the deal. The frontend should show this task prominently in their "My Tasks" view since it's marked `priority: "High"`.

---

## 9. Task Number Format

- Format: `TASK-001`, `TASK-002`, etc.
- Sequential per organization (not globally)
- Auto-generated on creation (pre-save hook)
- The `taskNumber` field is the stored string
- The `sequenceNumber` field is the numeric counter
- Virtual `displayId` returns the formatted string

**Note**: Task numbers never reset. If you delete/cancel TASK-005, the next task is TASK-006, not TASK-005.

---

## 10. Real-Time Considerations

Currently the system does NOT have WebSocket/real-time push. The frontend should:

1. **Poll the My Tasks endpoint** periodically (e.g., every 60 seconds) if you want near-real-time task updates
2. **Refresh the task list** after any mutation (create, update, status change, comment)
3. Auto-generated tasks will appear on the next poll/refresh — users won't see them instantly

If real-time is needed later, we can add Socket.io events for:
- `task:created`, `task:updated`, `task:status_changed`
- `task:assigned` (when a task is assigned to the user)
- `task:escalated` (when a task is escalated)
- `task:comment_added`

---

## 11. Files Changed (for code review reference)

| File | What Changed |
|---|---|
| `config/permissions.js` | Added 10 TASKS permissions |
| `data/defaultRoles.js` | Added task permissions to all 12 default role definitions |
| `data/migrateTaskPermissions.js` | One-time migration script (already ran for existing orgs) |
| `models/taskModel.js` | New — Task model with state machine, hierarchy, SLA, auto-generation |
| `models/taskTemplateModel.js` | New — Template model for reusable task definitions |
| `controllers/taskController.js` | New — 22 endpoint handlers |
| `routes/taskRoutes.js` | New — All routes with permission middleware |
| `services/taskAutoGenerationService.js` | New — Cron-based auto-task creation + escalation |
| `services/taskNotificationService.js` | New — Email notification stubs for task events |
| `services/backgroundJobService.js` | Modified — Added 3 task job types for on-demand triggering |
| `services/copilotFunctions.js` | Modified — Added 6 task-related GPT-4 function tools |
| `services/aiCopilotService.js` | Modified — System prompt + intent detection updated for tasks |
| `server.js` | Modified — Registered `/api/tasks` routes, updated health check |

---

## 12. Quick Checklist for Frontend Developer

- [ ] **Task List page** — with filters (status, priority, category, assignedTo, search, overdue toggle)
- [ ] **Task Detail page** — full info, status transition buttons, checklist toggles, comments, sub-tasks, activity log, entity link
- [ ] **Create Task form** — title, description, category, priority, assignee, due date, tags, checklist, entity link, recurrence
- [ ] **My Tasks dashboard** — overdue / due today / due this week / in progress sections
- [ ] **Team Tasks view** (managers) — workload per team member, filter by assignee
- [ ] **Task Analytics page** — charts for status, priority, category distribution, completion rate, overdue aging, SLA compliance
- [ ] **Template management** — CRUD for templates, "Apply Template" button
- [ ] **Bulk operations** — multi-select tasks for bulk assign / bulk status update
- [ ] **Kanban board** (optional) — drag-and-drop status transitions
- [ ] **Auto-generated task badge** — visual indicator for system-created tasks
- [ ] **Escalation indicator** — warning icons for escalated tasks
- [ ] **Recurring task icon** — visual indicator + link to generated instances
- [ ] **Entity link navigation** — clickable links to related entities (leads, sales, installments, etc.)
- [ ] **Copilot integration** — no changes needed, already works through existing chat UI

---

*Last Updated: February 2026*
